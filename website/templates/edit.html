{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block instructions%}Edit calculated curves{% endblock %}
 
{% block content %}
  <div id="calculator" style="width: 1050px; height: 600px; margin-bottom: 1em;"></div>
  
  <!-- <form method="POST" enctype="multipart/form-data">
    <input type="hidden" id="imgURL" name="imgURL" value="">
    <input type="file" id="imgFile" name="imgFile">
    <input type="hidden" id="calcState" name="calcState" value="">
    <input type="submit" value="Store image data">
  </form> -->


  <script>
    let controlPoints = '{{controlPoints}}';
    controlPoints = controlPoints.slice(1,-1).split(',');
    let expression_states = [];
    let counter = 0;

    console.log(controlPoints);

    function splitArrayIntoChunksOfLen(arr, len) {
      var chunks = [], i = 0, n = arr.length;
      while (i < n) {
        chunks.push(arr.slice(i, i += len));
      }
      return chunks;
    }

    function convert8ElementArray(cpArray, index) {
      var CPs = splitArrayIntoChunksOfLen(cpArray,2)
      CPs.forEach(convert2ElementArray);
      let n0 = index*4;
      let n1 = n0 + 1; 
      let n2 = n0 + 2;
      let n3 = n0 + 3;
      let bezierEqn = `((1-t)((1-t)((1-t)x_${n0}+tx_${n1})+t((1-t)x_${n1}+tx_${n2}))+t((1-t)((1-t)x_${n1}+tx_${n2})+t((1-t)x_${n2}+tx_${n3})),(1-t)((1-t)((1-t)y_${n0}+ty_${n1})+t((1-t)y_${n1}+ty_${n2}))+t((1-t)((1-t)y_${n1}+ty_${n2})+t((1-t)y_${n2}+ty_${n3})))`;
      let bezier = {
        latex: bezierEqn,
        parametricDomain: {min: '0', max: '1'}
      };

      let guide1 = {
        latex: `((1-t)x_${n0} + tx_${n1},(1-t)y_${n0} + ty_${n1})`,
        parametricDomain: {min: '0', max: '1'}
      };

      let guide2 = {
        latex: `((1-t)x_${n1} + tx_${n2},(1-t)y_${n1} + ty_${n2})`,
        parametricDomain: {min: '0', max: '1'}
      };

      let guide3 = {
        latex: `((1-t)x_${n2} + tx_${n3},(1-t)y_${n2} + ty_${n3})`,
        parametricDomain: {min: '0', max: '1'}
      };

      expression_states.push(bezier, guide1, guide2, guide3);
    }

    function convert2ElementArray(cpArray) {
      var x = {
        latex: 'x_' + counter + `=${counter}`
      }

      var y = {
        latex: 'y_' + counter + `=${counter}`
      }

      var xy = {
        latex: '(x_' + counter + ',y_' + counter + ')'
      }

      expression_states.push(x,y,xy);
      counter += 1;
    }

    
    var cp2 =splitArrayIntoChunksOfLen(controlPoints,8);

    cp2.forEach(convert8ElementArray);

    console.log(cp2);
    console.log(expression_states)
    

    var elt = document.getElementById('calculator');
    var calculator = Desmos.GraphingCalculator(elt);
    expression_states.forEach(function(expression_state) {
      calculator.setExpression(expression_state);
    });
    // calculator.setExpression({
    //   latex: '(x_0,y_0)'
    // });
    // calculator.setExpression({
    //   latex: '(x_1,y_1)'
    // });
    // calculator.setExpression({
    //   latex: '(x_2,y_2)'
    // });
    // calculator.setExpression({
    //   latex: '(x_3,y_3)'
    // });

    // var random = calculator.HelperExpression({latex: '(x_0,y_0)'});

    // random.observe('numericValue', function() {
    //   console.log(random.numericValue);
    // })

    // calculator.setExpression({
    //   latex: 'x_0=10'
    // });
    // calculator.setExpression({
    //   latex: 'x_1=33'
    // });
    // calculator.setExpression({
    //   latex: 'x_2=5'
    // });
    // calculator.setExpression({
    //   latex: 'x_3=7'
    // });

    // calculator.setExpression({
    //   latex: 'y_0=10'
    // });
    // calculator.setExpression({
    //   latex: 'y_1=33'
    // });
    // calculator.setExpression({
    //   latex: 'y_2=5'
    // });
    // calculator.setExpression({
    //   latex: 'y_3=7'
    // });

    // calculator.setExpression({
    //   latex: '((1-t)((1-t)((1-t)x_0+tx_1)+t((1-t)x_1+tx_2))+t((1-t)((1-t)x_1+tx_2)+t((1-t)x_2+tx_3)),(1-t)((1-t)((1-t)y_0+ty_1)+t((1-t)y_1+ty_2))+t((1-t)((1-t)y_1+ty_2)+t((1-t)y_2+ty_3)))',
    //   parametricDomain: {min: '0', max: '1'}
    // });

    // calculator.setExpression({
    //   latex: '((1-t)x_0 + tx_1,(1-t)y_0 + ty_1)',
    //   parametricDomain: {min: '0', max: '1'}
    // });

    // calculator.setExpression({
    //   latex: '((1-t)x_1 + tx_2,(1-t)y_1 + ty_2)',
    //   parametricDomain: {min: '0', max: '1'}
    // });

    // calculator.setExpression({
    //   latex: '((1-t)x_2 + tx_3,(1-t)y_2 + ty_3)',
    //   parametricDomain: {min: '0', max: '1'}
    // });
    



    
    
  </script>

  
  <script>
    // var elt = document.getElementById('calculator');
    // var calculator = Desmos.GraphingCalculator(elt, {
    //   imageUploadCallback: function (file, cb) {
    //     console.log(file)
    //     Desmos.imageFileToDataURL(file, function (err, dataURL) {
    //       storeImageData(dataURL);
    //       if (err) {
    //         cb(err);
    //       } else {
    //         cb(null, dataURL);
    //       }
    //     });
    //   }
    // });
    
    // function storeImageData(dataURL) {
    //   localStorage.setItem("imgURL", dataURL);
    //   localStorage.setItem("calcState", calculator.getState());
    //   document.getElementById("imgURL").value = dataURL;
    //   document.getElementById("calcState").value = calculator.getState();
    // }
    
  </script>
{% endblock %}